> [!NOTE]
> This document is auto-generated by LLM. Errors may exist.

# Proxy Configuration

This document explains how to configure proxies and proxy groups in Boltconn.

## Overview

Boltconn supports various proxy types and allows you to organize them into groups for intelligent routing. Proxies can be defined locally or loaded from external providers.

## Local Proxy Configuration

Define proxies in the `proxy_local` section of your configuration:

```yaml
proxy_local:
  my-proxy:
    type: socks5
    server: 127.0.0.1
    port: 1080

  my-trojan:
    type: trojan
    server: example.com
    port: 443
    password: mypassword
    sni: example.com
```

## Proxy Types

### HTTP

HTTP proxy with optional authentication.

**Configuration:**

```yaml
proxy_local:
  my-http:
    type: http
    server: proxy.example.com  # IP address or domain
    port: 8080
    auth:                      # Optional
      username: myuser
      password: mypass
```

**Fields:**
- `type`: `http` (required)
- `server`: Server address - IP address or domain name (required)
- `port`: Port number (required)
- `auth`: Authentication credentials (optional)
  - `username`: Username
  - `password`: Password

### SOCKS5

SOCKS5 proxy with optional authentication and UDP support.

**Configuration:**

```yaml
proxy_local:
  my-socks5:
    type: socks5
    server: 127.0.0.1
    port: 1080
    auth:                      # Optional
      username: myuser
      password: mypass
    udp: true                  # Default: true
```

**Fields:**
- `type`: `socks5` (required)
- `server`: Server address - IP address or domain name (required)
- `port`: Port number (required)
- `auth`: Authentication credentials (optional)
  - `username`: Username
  - `password`: Password
- `udp`: Enable UDP relay (optional, default: `true`)

### Shadowsocks

Shadowsocks proxy with various cipher support.

**Configuration:**

```yaml
proxy_local:
  my-ss:
    type: ss
    server: ss.example.com
    port: 8388
    password: mypassword
    cipher: chacha20-ietf-poly1305
    udp: true                  # Default: true
```

**Fields:**
- `type`: `ss` (required)
- `server`: Server address - IP address or domain name (required)
- `port`: Port number (required)
- `password`: Password (required)
- `cipher`: Encryption cipher (required)
  - Common ciphers: `chacha20-ietf-poly1305`, `aes-256-gcm`, `aes-128-gcm`
- `udp`: Enable UDP relay (optional, default: `true`)

**Supported Ciphers:**
- `chacha20-ietf-poly1305`
- `aes-256-gcm`
- `aes-128-gcm`
- `aes-256-cfb`
- `aes-128-cfb`
- And others supported by the shadowsocks-rust library

### Trojan

Trojan protocol proxy with TLS support.

**Configuration:**

```yaml
proxy_local:
  my-trojan:
    type: trojan
    server: trojan.example.com
    port: 443
    password: mypassword
    sni: trojan.example.com         # Server Name Indication
    skip_cert_verify: false         # Default: true
    websocket_path: /ws             # Optional WebSocket path
    udp: true                       # Default: true
```

**Fields:**
- `type`: `trojan` (required)
- `server`: Server address - IP address or domain name (required)
- `port`: Port number (required)
- `password`: Password (required)
- `sni`: Server Name Indication for TLS (required)
- `skip_cert_verify`: Skip TLS certificate verification (optional, default: `true`)
- `websocket_path`: WebSocket path for WebSocket transport (optional)
- `udp`: Enable UDP relay (optional, default: `true`)

**Example with WebSocket:**

```yaml
proxy_local:
  trojan-ws:
    type: trojan
    server: example.com
    port: 443
    password: password123
    sni: example.com
    skip_cert_verify: false
    websocket_path: /trojan
    udp: true
```

### WireGuard

WireGuard VPN protocol with IPv4/IPv6 support.

**Configuration:**

```yaml
proxy_local:
  my-wg:
    type: wireguard
    local_addr: 10.33.0.2                    # Optional IPv4 address
    local_addr_v6: 2606:4700:110:1::2        # Optional IPv6 address
    private_key: YourBase64PrivateKey==
    public_key: ServerBase64PublicKey==
    endpoint: vpn.example.com:51820          # IP:port or domain:port
    dns: 1.1.1.1                             # DNS server
    dns_preference: prefer-ipv4              # Default: prefer-ipv4
    mtu: 1420                                # MTU size
    preshared_key: Base64PresharedKey==      # Optional
    keepalive: 25                            # Optional, in seconds
    reserved: [134, 77, 85]                  # Optional, 3 bytes
    over_tcp: false                          # Default: false
```

**Fields:**
- `type`: `wireguard` (required)
- `local_addr`: Local IPv4 address (optional)
- `local_addr_v6`: Local IPv6 address (optional)
- `private_key`: Base64-encoded private key (required)
- `public_key`: Base64-encoded server public key (required)
- `endpoint`: Server endpoint - IP:port or domain:port (required)
- `dns`: DNS server IP address (required)
- `dns_preference`: IP version preference (optional, default: `prefer-ipv4`)
  - Options: `ipv4-only`, `ipv6-only`, `prefer-ipv4`, `prefer-ipv6`
- `mtu`: Maximum Transmission Unit size (required)
- `preshared_key`: Base64-encoded pre-shared key (optional)
- `keepalive`: Keepalive interval in seconds (optional)
- `reserved`: Reserved bytes as array of 3 integers (optional)
- `over_tcp`: Use TCP transport instead of UDP (optional, default: `false`)

**Note:** WireGuard creates a persistent connection. Monitor it via the `/connections/master` API endpoint.

### SSH

SSH tunnel proxy with password or key-based authentication.

**Configuration:**

```yaml
proxy_local:
  my-ssh:
    type: ssh
    server: ssh.example.com
    port: 22
    user: myuser
    password: mypassword             # Optional (password auth)
    private_key: ~/.ssh/id_rsa       # Optional (key auth)
    key_passphrase: keypass          # Optional (for encrypted keys)
    host_pubkey:                     # Optional (verify server key)
      - "ssh-ed25519 AAAAC3..."
      - "ssh-rsa AAAAB3..."
```

**Fields:**
- `type`: `ssh` (required)
- `server`: Server address - IP address or domain name (required)
- `port`: Port number (required)
- `user`: Username (required)
- `password`: Password for password authentication (optional)
- `private_key`: Path to private key file (optional)
- `key_passphrase`: Passphrase for encrypted private key (optional)
- `host_pubkey`: Server public key fingerprints for verification (optional)
  - Can be a single string or array of strings

**Authentication Methods:**

1. **Password authentication:**
   ```yaml
   my-ssh:
     type: ssh
     server: example.com
     port: 22
     user: alice
     password: secret123
   ```

2. **Key-based authentication:**
   ```yaml
   my-ssh:
     type: ssh
     server: example.com
     port: 22
     user: alice
     private_key: ~/.ssh/id_ed25519
   ```

3. **Encrypted key with passphrase:**
   ```yaml
   my-ssh:
     type: ssh
     server: example.com
     port: 22
     user: alice
     private_key: ~/.ssh/id_rsa
     key_passphrase: mykeypass
   ```

4. **With host key verification:**
   ```yaml
   my-ssh:
     type: ssh
     server: example.com
     port: 22
     user: alice
     private_key: ~/.ssh/id_rsa
     host_pubkey: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGz..."
   ```

**Note:** SSH creates a persistent connection. Monitor it via the `/connections/master` API endpoint.

## Proxy Providers

Load proxies from external sources (files or HTTP endpoints).

### File Provider

Load proxies from a local or remote file.

**Configuration:**

```yaml
proxy_provider:
  my-file-provider:
    type: file
    path: ./proxies/my-proxies.yaml
```

**Fields:**
- `type`: `file` (required)
- `path`: Path to proxy file - relative or absolute (required)

### HTTP Provider

Automatically fetch and update proxies from HTTP(S) URL.

**Configuration:**

```yaml
proxy_provider:
  my-http-provider:
    type: http
    url: https://example.com/proxies.yaml
    path: ./cache/proxies.yaml
    interval: 3600  # Update every hour
```

**Fields:**
- `type`: `http` (required)
- `url`: HTTP(S) URL to fetch proxies from (required)
- `path`: Local cache file path (required)
- `interval`: Update interval in seconds (required)

### Provider File Format

Provider files must use this format:

```yaml
proxies:
  - name: proxy-1
    type: socks5
    server: 127.0.0.1
    port: 1080

  - name: proxy-2
    type: ss
    server: ss.example.com
    port: 8388
    password: password
    cipher: chacha20-ietf-poly1305

  - name: proxy-3
    type: trojan
    server: trojan.example.com
    port: 443
    password: password
    sni: trojan.example.com
```

Each proxy in the `proxies` array must have a `name` field and follow the same structure as local proxies.

## Proxy Groups

Proxy groups organize proxies for routing rules. There are two types of groups:

### Selection Groups

Allow selecting one proxy from a list for routing.

**Configuration:**

```yaml
proxy_group:
  Proxy:
    proxies:                  # Direct proxy names
      - my-proxy
      - my-ss
      - DIRECT
    providers:                # Provider references
      - my-provider           # Use all proxies from provider
      - name: filtered        # Use filtered proxies
        filter: "US.*"        # Regex filter on proxy names
    interface: en0            # Optional: bind to specific interface
```

**Fields:**
- `proxies`: List of proxy names (optional)
- `providers`: List of provider references (optional)
  - Simple form: provider name (string)
  - Complex form: `{name: provider_name, filter: regex_pattern}`
- `interface`: Network interface to bind (optional)

**Note:** You must specify at least one of `proxies` or `providers`.

**Example with Filtering:**

```yaml
proxy_group:
  US-Proxies:
    providers:
      - name: all-proxies
        filter: "^US-.*"      # Only proxies starting with "US-"

  Low-Latency:
    providers:
      - name: all-proxies
        filter: ".*-premium$" # Only proxies ending with "-premium"
```

### Chain Groups

Chain multiple proxies sequentially (proxy through proxy).

**Configuration:**

```yaml
proxy_group:
  MyChain:
    chains:
      - proxy-1
      - proxy-2
      - proxy-3
    interface: en0            # Optional
```

**Fields:**
- `chains`: Ordered list of proxy names to chain (required)
- `interface`: Network interface to bind (optional)

**Example:**

```yaml
proxy_local:
  entry-proxy:
    type: socks5
    server: entry.example.com
    port: 1080

  exit-proxy:
    type: ss
    server: exit.example.com
    port: 8388
    password: password
    cipher: chacha20-ietf-poly1305

proxy_group:
  DoubleHop:
    chains:
      - entry-proxy
      - exit-proxy
```

Traffic flows: Your App � entry-proxy � exit-proxy � Destination

**Note:** Cannot mix `proxies`/`providers` with `chains` in the same group.

## Special Proxy Names

Boltconn provides built-in proxy names for common actions:

### DIRECT

Direct connection without any proxy.

```yaml
rule_local:
  - DOMAIN-SUFFIX, local, DIRECT
```

### REJECT

Reject the connection (connection will fail).

```yaml
rule_local:
  - DOMAIN-SUFFIX, ads.example.com, REJECT
```

### BLACKHOLE

Silently drop the connection (no response).

```yaml
rule_local:
  - DOMAIN, spam.example.com, BLACKHOLE
```

## Proxy Selection

### Manual Selection via API

Use the RESTful API to select which proxy to use in a group:

```bash
# Get current selection
curl http://localhost:9000/proxies/Proxy

# Set selection
curl -X PUT http://localhost:9000/proxies/Proxy \
  -H "Content-Type: application/json" \
  -d '{"selected": "my-proxy"}'
```

### Latency Testing

Trigger latency testing for all proxies in a group:

```bash
curl http://localhost:9000/speedtest/Proxy
```

Results are returned via the `/proxies/:group` endpoint, showing latency for each proxy.

## Complete Example

Here's a complete example combining local proxies, providers, and groups:

```yaml
# Local proxy definitions
proxy_local:
  local-socks:
    type: socks5
    server: 127.0.0.1
    port: 1080

  my-trojan:
    type: trojan
    server: trojan.example.com
    port: 443
    password: password123
    sni: trojan.example.com

  my-wg:
    type: wireguard
    local_addr: 10.33.0.2
    private_key: privatekey==
    public_key: publickey==
    endpoint: wg.example.com:51820
    dns: 1.1.1.1
    mtu: 1420

# Proxy providers
proxy_provider:
  subscription:
    type: http
    url: https://provider.example.com/proxies.yaml
    path: ./cache/subscription.yaml
    interval: 86400  # Update daily

  backup:
    type: file
    path: ./proxies/backup.yaml

# Proxy groups
proxy_group:
  # Selection group with mixed sources
  Proxy:
    proxies:
      - local-socks
      - my-trojan
      - DIRECT
    providers:
      - subscription
      - name: backup
        filter: "premium.*"

  # US-only proxies
  US:
    providers:
      - name: subscription
        filter: "^US-.*"

  # Chain for double-hop
  DoubleHop:
    chains:
      - my-trojan
      - my-wg
    interface: en0

# Use in rules
rule_local:
  - DOMAIN-SUFFIX, google.com, Proxy
  - GEOIP, US, US
  - DOMAIN, sensitive.example.com, DoubleHop
  - FALLBACK, Proxy
```

