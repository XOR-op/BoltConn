> [!NOTE]
> This document is auto-generated by LLM. Errors may exist.

# Configuration Guide

Boltconn uses YAML format for configuration files. This guide explains the overall structure and available configuration options.

## Configuration File Structure

The main configuration file consists of several top-level sections:

```yaml
# Network interface (required)
interface: auto  # or specific interface name like "en0"

# DNS configuration (required)
dns:
  ...

# Inbound services (optional)
inbound:
  ...

# Proxy groups (required)
proxy_group:
  ...

# Additional optional sections
web_controller: ...
instrument: ...
dispatching: ...
proxy_local: ...
proxy_provider: ...
rule_local: ...
rule_provider: ...
interception: ...
module: ...
```

## Required Configuration Sections

### Interface

Specifies which network interface to use for connections.

```yaml
interface: auto  # Auto-detect interface
# or
interface: en0   # Use specific interface
```

### DNS Configuration

Configure DNS resolution behavior. See [DNS Configuration](#dns-configuration-1) section below for details.

```yaml
dns:
  preference: prefer-ipv4
  bootstrap:
    - 8.8.8.8
  nameserver:
    - "doh, 1.1.1.1"
```

### Proxy Groups

Define proxy groups for routing. This is required even if you only use `DIRECT` connections. See [proxy.md](proxy.md) for detailed proxy configuration.

```yaml
proxy_group:
  Proxy:
    proxies:
      - my-proxy
      - DIRECT
```

## Optional Configuration Sections

### Inbound Services

Configure inbound proxy services (TUN, HTTP, SOCKS5).

**Default values** (when `inbound` is not specified):
```yaml
inbound:
  enable_tun: true
  enable_icmp_proxy: true
```

**Full configuration:**

```yaml
inbound:
  enable_tun: true           # Enable TUN device (default: true)
  enable_icmp_proxy: true    # Enable ICMP proxying (default: true)

  # HTTP inbound service
  http:
    - port: 7890
    # or with full options:
    - host: 127.0.0.1
      port: 7890
      alias: my-http        # Optional alias for rule matching
      auth:                 # Optional authentication
        username1:
          password: pass1

  # SOCKS5 inbound service
  socks5:
    - port: 1080
    # or with full options:
    - host: 127.0.0.1
      port: 1080
      alias: my-socks
      auth:
        user1:
          password: pass1
```

**Inbound Service Formats:**

1. **Simple port number:**
   ```yaml
   http: 7890
   # Binds to 127.0.0.1:7890
   ```

2. **Socket address:**
   ```yaml
   http: "0.0.0.0:7890"
   ```

3. **Multiple services:**
   ```yaml
   http:
     - 7890
     - 7891
   ```

4. **With authentication and alias:**
   ```yaml
   http:
     host: 0.0.0.0
     port: 7890
     alias: public-http
     auth:
       alice:
         password: secret123
       bob:
         password: secret456
   ```

### Web Controller (RESTful API)

Enable the RESTful API for remote control. See [restful.md](restful.md) for API documentation.

```yaml
web_controller:
  api_addr: 9000                    # Port number or socket address
  api_key: your-secret-key          # Optional authentication
  cors_allowed_list:                # Optional CORS origins
    - "http://localhost:3000"
```

### Instrument Server

Enable instrumentation/telemetry server for monitoring.

```yaml
instrument:
  api_addr: 9001
  secret: instrument-secret
  cors_allowed_list:
    - "http://localhost:3000"
```

### Dispatching Options

Advanced routing and traffic inspection options.

```yaml
dispatching:
  sni_sniff: false           # Enable SNI sniffing (default: false)
  geoip_db: /path/to/GeoLite2-Country.mmdb  # Optional GeoIP database
```

**Note:** The `geoip_db` is required if you want to use `GEOIP` or `ASN` rules.

### Database Dumping

Enable connection database for persistence.

```yaml
enable_dump: false  # Default: false
```

### Speed Test URL

Customize the URL used for proxy latency testing.

```yaml
speedtest_url: "http://www.gstatic.com/generate_204"  # Default
```

## DNS Configuration

The DNS section controls how domain names are resolved.

### Basic DNS Configuration

```yaml
dns:
  # IP version preference
  preference: prefer-ipv4  # Options: ipv4-only, ipv6-only, prefer-ipv4, prefer-ipv6

  # Bootstrap DNS (IP addresses only, used to resolve nameserver hostnames)
  bootstrap:
    - 8.8.8.8
    - 1.1.1.1

  # Primary nameservers (supports various protocols)
  nameserver:
    - "doh, 1.1.1.1"          # DNS over HTTPS
    - "udp, 8.8.8.8"          # UDP DNS
    - "dot-preset, cloudflare" # DNS over TLS (preset)
    - "dhcp, en0"             # Use DHCP DNS from interface
```

### Nameserver Formats

1. **DNS over HTTPS (DoH):**
   ```yaml
   - "doh, 1.1.1.1"
   - "doh, https://dns.google/dns-query"
   ```

2. **UDP DNS:**
   ```yaml
   - "udp, 8.8.8.8"
   - "udp, 8.8.8.8:53"
   ```

3. **DNS over TLS (DoT) - Preset:**
   ```yaml
   - "dot-preset, cloudflare"  # Uses cloudflare-dns.com
   - "dot-preset, google"      # Uses dns.google
   ```

4. **DHCP DNS:**
   ```yaml
   - "dhcp, en0"  # Use DNS from interface en0
   ```

### Advanced DNS Options

```yaml
dns:
  # Static host mappings (like /etc/hosts)
  hosts:
    example.com: 1.2.3.4
    local.dev: 127.0.0.1

  # Domain-specific DNS routing
  nameserver_policy:
    "example.com": "doh, 1.1.1.1"

  # TUN DNS hijacking/bypassing
  tun_hijack_list:
    - 53/udp              # Hijack UDP port 53
    - 8.8.8.8:53          # Hijack specific DNS server

  tun_bypass_list:
    - 127.0.0.1:53        # Don't hijack localhost DNS
```

## Proxy Configuration

Define local proxies and proxy providers. See [proxy.md](proxy.md) for complete documentation.

### Local Proxies

```yaml
proxy_local:
  my-proxy:
    type: socks5
    server: 127.0.0.1
    port: 1080

  my-ss:
    type: ss
    server: example.com
    port: 8388
    password: mypassword
    cipher: chacha20-ietf-poly1305
```

### Proxy Providers

Load proxies from external sources:

```yaml
proxy_provider:
  my-provider:
    type: http
    url: https://example.com/proxies.yaml
    path: ./cache/proxies.yaml
    interval: 3600  # not working yet
```

## Routing Rules

Define routing rules to determine which proxy to use. See [rule.md](rule.md) for complete rule syntax.

### Local Rules

```yaml
rule_local:
  - DOMAIN-SUFFIX, google.com, Proxy
  - DOMAIN-SUFFIX, local, DIRECT
  - FALLBACK, Proxy
```

### Rule Providers

Load rules from external sources:

```yaml
rule_provider:
  cn-direct:
    type: file
    behavior: domain
    path: ./rules/cn-domains.yaml

  reject-ads:
    type: http
    behavior: domain
    url: https://example.com/ad-rules.yaml
    path: ./cache/ad-rules.yaml

# Use in rules
rule_local:
  - RULE-SET, cn-direct, DIRECT
  - RULE-SET, reject-ads, REJECT
```

## HTTP/HTTPS Interception

Configure HTTP/HTTPS traffic interception and modification.

```yaml
interception:
  - name: capture-api
    enabled: true
    parrot-fingerprint: false  # Mimic client TLS fingerprint
    filters:
      # Rules without proxy specification
      - DOMAIN-SUFFIX, api.example.com
      - DST-PORT, 443
    actions:
      - capture  # Capture full HTTP traffic

      # Modify requests
      - type: req
        name: add-header
        script: |
          headers["X-Custom-Header"] = "value";

      # Modify responses
      - type: resp
        name: modify-json
        pattern: "application/json"
        script: |
          let data = JSON.parse(body);
          data.modified = true;
          body = JSON.stringify(data);
```

**Available Actions:**
- `capture` - Capture HTTP request/response for inspection
- URL redirection
- Header modification (req/resp)
- JavaScript-based body modification

## Module System

Split configuration into multiple files for better organization.

```yaml
module:
  # File-based module
  - name: custom-rules
    type: file
    path: ./modules/custom-rules.yaml

  # HTTP-based module
  - name: remote-config
    type: http
    url: https://example.com/config.yaml
    path: ./cache/remote-config.yaml
    interval: 3600
```

**Module File Format:**

```yaml
# modules/custom-rules.yaml
rule-local:
  - DOMAIN, example.com, DIRECT

rule-provider:
  my-rules:
    type: file
    path: ./my-rules.yaml

interception:
  - name: example
    enabled: true
    filters: [...]
    actions: [...]
```

## Complete Example

Here's a complete configuration example:

```yaml
interface: auto

dns:
  preference: prefer-ipv4
  bootstrap:
    - 8.8.8.8
  nameserver:
    - "doh, 1.1.1.1"
    - "udp, 8.8.8.8"
  nameserver_policy:
    "*.internal": "udp, 192.168.1.1"

inbound:
  enable_tun: true
  http: 7890
  socks5: 1080

web_controller:
  api_addr: 9000
  api_key: secret-key

dispatching:
  geoip_db: ./GeoLite2-Country.mmdb

proxy_local:
  my-proxy:
    type: socks5
    server: 127.0.0.1
    port: 7891

proxy_group:
  Proxy:
    proxies:
      - my-proxy
      - DIRECT

rule_local:
  - DOMAIN-SUFFIX, google.com, Proxy
  - DOMAIN-SUFFIX, local, DIRECT
  - FALLBACK, Proxy
```

## State Persistence

Boltconn maintains a `state.yml` file to persist:
- Selected proxy for each group
- Temporary rules
- Connection log limit

This file is automatically managed and should not be manually edited.
