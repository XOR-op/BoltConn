> [!NOTE]
> This document is auto-generated by LLM. Errors may exist.

# Routing Rules

This document explains the routing rule system in Boltconn, which determines how connections are routed through different proxies.

## Overview

Rules are evaluated in order from top to bottom. The first matching rule determines which proxy group or action is used. Rules are specified in the `rule_local` section as YAML arrays.

## Rule Syntax

Rules use a simple array format:

```yaml
rule_local:
  - RULE-TYPE, CONTENT, PROXY-OR-GROUP
```

- **RULE-TYPE:** The type of rule (e.g., `DOMAIN`, `IP-CIDR`, `GEOIP`)
- **CONTENT:** The matching criterion (e.g., domain name, IP range)
- **PROXY-OR-GROUP:** Which proxy group or action to use (`DIRECT`, `REJECT`, etc.)

## Domain Matching Rules

#### DOMAIN

Exact domain name match.

```yaml
- DOMAIN, example.com, Proxy
- DOMAIN, www.google.com, Proxy
```

Matches only the exact domain specified, not subdomains.

#### DOMAIN-SUFFIX

Domain suffix match (includes the domain and all subdomains).

```yaml
- DOMAIN-SUFFIX, google.com, Proxy
- DOMAIN-SUFFIX, local, DIRECT
```

Examples:
- `google.com` matches: `google.com`, `www.google.com`, `mail.google.com`
- `local` matches: `local`, `myserver.local`

#### DOMAIN-KEYWORD

Domain contains keyword.

```yaml
- DOMAIN-KEYWORD, google, Proxy
- DOMAIN-KEYWORD, analytics, REJECT
```

Matches any domain containing the keyword anywhere in the domain name.

Examples:
- `google` matches: `google.com`, `www.google.com`, `google-analytics.com`
- `analytics` matches: `analytics.google.com`, `my-analytics.net`

## IP and Network Rules

#### IP-CIDR

IPv4 CIDR range match.

```yaml
- IP-CIDR, 192.168.0.0/16, DIRECT
- IP-CIDR, 10.0.0.0/8, DIRECT
- IP-CIDR, 1.1.1.1/32, Proxy
- IP-CIDR, 8.8.8.8/32, Proxy, no-resolve
```

**Optional `no-resolve` flag:** Skip DNS resolution. Use this to avoid resolving domain names to IPs before checking the rule. Useful for performance or when you want domain-based rules to take precedence.

**Common use cases:**
```yaml
# Private networks
- IP-CIDR, 10.0.0.0/8, DIRECT
- IP-CIDR, 172.16.0.0/12, DIRECT
- IP-CIDR, 192.168.0.0/16, DIRECT

# Specific server
- IP-CIDR, 1.2.3.4/32, Proxy
```

#### IP-CIDR6

IPv6 CIDR range match.

```yaml
- IP-CIDR6, 2001:db8::/32, Proxy
- IP-CIDR6, fe80::/10, DIRECT
- IP-CIDR6, ::1/128, DIRECT, no-resolve
```

Also supports the optional `no-resolve` flag.

#### LOCAL-IP-CIDR

Match local (source or destination) IP addresses in the connection.

```yaml
- LOCAL-IP-CIDR, 127.0.0.0/8, DIRECT
- LOCAL-IP-CIDR, 10.0.0.0/8, DIRECT
```

Useful for matching local network interfaces.

#### SRC-IP-CIDR

Match source IP address (where the connection originates from).

```yaml
- SRC-IP-CIDR, 192.168.1.0/24, DIRECT
- SRC-IP-CIDR, 10.0.5.0/24, Proxy
```

Useful for routing based on which device or network segment initiated the connection.

## Port Rules

#### SRC-PORT

Match source port.

```yaml
# Any protocol, port 8080
- SRC-PORT, 8080, DIRECT

# TCP port 443
- SRC-PORT, 443/tcp, Proxy

# UDP port 53
- SRC-PORT, 53/udp, DIRECT

# All TCP traffic
- SRC-PORT, tcp, Proxy

# All UDP traffic
- SRC-PORT, udp, DIRECT
```

**Formats:**
- `PORT` - Any protocol, specific port
- `PORT/tcp` - TCP, specific port
- `PORT/udp` - UDP, specific port
- `tcp` - All TCP traffic
- `udp` - All UDP traffic

#### DST-PORT

Match destination port.

```yaml
- DST-PORT, 80, DIRECT
- DST-PORT, 443, Proxy
- DST-PORT, 22/tcp, DIRECT
- DST-PORT, 53/udp, DIRECT
```

Uses the same format as `SRC-PORT`.

**Common use cases:**

```yaml
# HTTP/HTTPS
- DST-PORT, 80, Proxy
- DST-PORT, 443, Proxy

# SSH
- DST-PORT, 22/tcp, DIRECT

# DNS
- DST-PORT, 53/udp, DIRECT

# Mail
- DST-PORT, 25/tcp, Proxy   # SMTP
- DST-PORT, 587/tcp, Proxy  # SMTP submission
```

## Process Rules

#### PROCESS-NAME

Exact process name match.

```yaml
- PROCESS-NAME, firefox, Proxy
- PROCESS-NAME, curl, DIRECT
- PROCESS-NAME, chrome, Proxy
```

Matches the exact process name (executable name without path).

#### PROCESS-KEYWORD

Process name contains keyword.

```yaml
- PROCESS-KEYWORD, chrome, Proxy
- PROCESS-KEYWORD, download, DIRECT
```

Matches if the process name contains the keyword.

Examples:
- `chrome` matches: `chrome`, `chrome-helper`, `google-chrome`

#### PROC-PATH-KEYWORD

Process path contains keyword.

```yaml
- PROC-PATH-KEYWORD, /usr/local/bin, DIRECT
- PROC-PATH-KEYWORD, /Applications/Firefox.app, Proxy
- PROC-PATH-KEYWORD, Downloads, REJECT
```

Matches if the full process path contains the keyword.

#### PROC-CMD-REGEX

Process command line matches regex.

```yaml
- PROC-CMD-REGEX, "^curl.*youtube\\.com", Proxy
- PROC-CMD-REGEX, "python.*scraper\\.py", Proxy
- PROC-CMD-REGEX, "git clone.*github\\.com", DIRECT
```

Matches the full command line (executable + arguments) against a regular expression.

**Note:** Use proper regex escaping (e.g., `\\.` for literal dot).

## Inbound Rules

#### INBOUND

Match based on which inbound service received the connection.

```yaml
# Match by service type and port
- INBOUND, http:7890, Proxy
- INBOUND, socks5:1080, DIRECT

# Match by service type only
- INBOUND, http, Proxy
- INBOUND, socks5, DIRECT
- INBOUND, tun, DIRECT

# Match by username and service
- INBOUND, alice@http:7890, Proxy
- INBOUND, bob@socks5:1080, REJECT
```

**Format:** `[username@]<service>[:<port>]`

- **service:** `http`, `socks5`, or `tun`
- **port:** Port number (optional)
- **username:** Authenticated username (optional)

**Examples:**

```yaml
# Route TUN traffic differently from proxy traffic
- INBOUND, tun, Auto-Select
- INBOUND, http, DIRECT

# Per-user routing
- INBOUND, premium-user@socks5, Premium-Proxies
- INBOUND, free-user@socks5, Free-Proxies

# Per-port routing
- INBOUND, http:7890, Proxy-A
- INBOUND, http:7891, Proxy-B
```

#### INBOUND-ALIAS

Match by inbound service alias (defined in `inbound` configuration).

```yaml
# Configuration
inbound:
  http:
    - port: 7890
      alias: work-proxy
    - port: 7891
      alias: personal-proxy

# Rules
rule_local:
  - INBOUND-ALIAS, work-proxy, Work-Proxies
  - INBOUND-ALIAS, personal-proxy, Personal-Proxies
```

More flexible than `INBOUND` as aliases can be descriptive names.

## GeoIP Rules

**Note:** Requires `geoip_db` to be configured in `dispatching` section.

#### GEOIP

Match by country code (ISO 3166-1 alpha-2).

```yaml
- GEOIP, US, US-Proxies
- GEOIP, JP, JP-Proxies
- GEOIP, CN, CN-Proxies
```

**Note:** Requires a GeoIP database (e.g., GeoLite2-Country.mmdb) configured via `dispatching.geoip_db`.

#### ASN

Match by Autonomous System Number.

```yaml
- ASN, 13335, Proxy  # Cloudflare
- ASN, 15169, Proxy  # Google
- ASN, 16509, Proxy  # Amazon
```

Useful for routing traffic based on the network operator.

**Note:** Requires a GeoIP database with ASN data.

## Rule Set

#### RULE-SET

Use rules from an external rule provider.

```yaml
# Define provider
rule_provider:
  custom-domains:
    type: file
    behavior: domain
    path: ./rules/custom-domains.yaml

  ad-blocking:
    type: http
    behavior: domain
    url: https://example.com/ad-rules.yaml
    path: ./cache/ad-rules.yaml
    interval: 86400

# Use in rules
rule_local:
  - RULE-SET, custom-domains, DIRECT
  - RULE-SET, ad-blocking, REJECT
  - FALLBACK, Proxy
```

See [Rule Providers](#rule-providers) section below for details.

## Logical Operators

#### AND

All sub-rules must match.

```yaml
- AND, [DOMAIN-SUFFIX, wikipedia.org], [DST-PORT, 443], Proxy
- AND, [PROCESS-NAME, curl], [DOMAIN-KEYWORD, github], DIRECT
```

**Syntax:** `AND, [rule1], [rule2], [rule3], ..., PROXY`

Each sub-rule is a rule without the proxy specification: `[TYPE, CONTENT]`

**Examples:**

```yaml
# Only match HTTPS Wikipedia
- AND, [DOMAIN-SUFFIX, wikipedia.org], [DST-PORT, 443], Proxy

# Only match Firefox accessing Google
- AND, [PROCESS-NAME, firefox], [DOMAIN-SUFFIX, google.com], Proxy
```

#### OR

Any sub-rule matches.

```yaml
- OR, [DOMAIN-SUFFIX, google.com], [DOMAIN-SUFFIX, youtube.com], Proxy
- OR, [PROCESS-NAME, chrome], [PROCESS-NAME, firefox], Proxy
- OR, [DST-PORT, 80], [DST-PORT, 443], Proxy
```

**Syntax:** `OR, [rule1], [rule2], [rule3], ..., PROXY`

**Examples:**

```yaml
# Match multiple Google services
- OR, [DOMAIN-SUFFIX, google.com], [DOMAIN-SUFFIX, googleapis.com], [DOMAIN-SUFFIX, gstatic.com], Proxy

# Match multiple browsers
- OR, [PROCESS-NAME, chrome], [PROCESS-NAME, firefox], [PROCESS-NAME, safari], Proxy

# Match HTTP or HTTPS
- OR, [DST-PORT, 80], [DST-PORT, 443], Proxy
```

#### NOT

Inverted match (matches when sub-rule doesn't match).

```yaml
- NOT, [DOMAIN-SUFFIX, local], Proxy
- NOT, [IP-CIDR, 192.168.0.0/16], Proxy
```

**Syntax:** `NOT, [rule], PROXY`

**Examples:**

```yaml
# Everything except .local domains
- NOT, [DOMAIN-SUFFIX, local], Proxy

# Everything except private IPs
- NOT, [IP-CIDR, 192.168.0.0/16], Proxy
```

**Complex example combining operators:**

```yaml
# Match (Chrome OR Firefox) AND (Google OR YouTube)
- AND, [OR, [PROCESS-NAME, chrome], [PROCESS-NAME, firefox]], [OR, [DOMAIN-SUFFIX, google.com], [DOMAIN-SUFFIX, youtube.com]], Proxy

# Match non-local HTTPS traffic
- AND, [NOT, [DOMAIN-SUFFIX, local]], [DST-PORT, 443], Proxy
```

## Special Rules

#### ALWAYS

Always matches (useful as a fallback or with logical operators).

```yaml
- ALWAYS, Proxy
```

#### NEVER

Never matches (useful for testing or with logical operators).

```yaml
- NEVER, Proxy
```

#### FALLBACK

Default rule when no other rules match. Should be the last rule.

```yaml
rule_local:
  - DOMAIN-SUFFIX, google.com, Proxy
  - FALLBACK, Proxy
```

**Note:** Only one `FALLBACK` rule should be used, and it must be at the end of the rule list.

## Special Actions

Special actions modify rule evaluation behavior instead of specifying a proxy.

### .LOCAL-RESOLVE

Force local DNS resolution at this point in the rule chain.

```yaml
rule_local:
  - DOMAIN-SUFFIX, example.com, Proxy
  - .LOCAL-RESOLVE
  - IP-CIDR, 1.2.3.0/24, DIRECT
```

Use this when you need to resolve domains before applying IP-based rules.

**Example use case:**

```yaml
# Resolve all domains first, then apply IP rules
- .LOCAL-RESOLVE
- IP-CIDR, 192.168.0.0/16, DIRECT
- IP-CIDR, 10.0.0.0/8, DIRECT
- FALLBACK, Proxy
```

### .SUB-DISPATCH

Conditional sub-ruleset based on a matching condition.

```yaml
- .SUB-DISPATCH:
    matches: <rule-without-proxy>
    subrules:
      - <rule1>
      - <rule2>
      - FALLBACK, <proxy>
```

**Example:**

```yaml
- .SUB-DISPATCH:
    matches: INBOUND, vscode/socks5
    subrules:
      - IP-CIDR, 8.0.0.0/8, DIRECT
      - DOMAIN-SUFFIX, github.com, Proxy
      - FALLBACK, REJECT
```

This creates a conditional ruleset that only applies when the main `matches` rule is true.

**Complex example:**

```yaml
# Different rules for different applications
- .SUB-DISPATCH:
    matches: PROCESS-NAME, firefox
    subrules:
      - DOMAIN-SUFFIX, google.com, US-Proxies
      - DOMAIN-SUFFIX, youtube.com, US-Proxies
      - FALLBACK, DIRECT

- .SUB-DISPATCH:
    matches: PROCESS-NAME, curl
    subrules:
      - DOMAIN-SUFFIX, github.com, DIRECT
      - FALLBACK, Proxy
```

### .INSTRUMENT

Logging and debugging action with template messages.

```yaml
- .INSTRUMENT:
    id: 1
    matches: <rule-without-proxy>
    message: "Template string with variables"
```

**Template Variables:**
- `{time.hms_ms}` - Timestamp (HH:MM:SS.mmm)
- `{addr.dst}` - Destination address
- `{process.cmdline}` - Process command line
- `{process.path}` - Process path
- `{process.parent_name}` - Parent process name

**Example:**

```yaml
- .INSTRUMENT:
    id: 100
    matches: DOMAIN-SUFFIX, api.example.com
    message: "[{time.hms_ms}] API call to {addr.dst} from {process.cmdline}"

- .INSTRUMENT:
    id: 101
    matches: PROCESS-NAME, suspicious-app
    message: "Suspicious app {process.path} (parent: {process.parent_name}) accessing {addr.dst}"
```

Instrument actions log messages when rules match, useful for debugging rule evaluation.

## Rule Providers

Load rules from external sources for better organization and automatic updates.

### Provider Types

#### File Provider

```yaml
rule_provider:
  my-rules:
    type: file
    behavior: domain          # domain, ipcidr, or classical
    path: ./rules/my-rules.yaml
```

#### HTTP Provider

```yaml
rule_provider:
  remote-rules:
    type: http
    behavior: domain
    url: https://example.com/rules.yaml
    path: ./cache/rules.yaml
    interval: 86400  # Update every 24 hours
```

### Behavior Types

1. **domain** - Contains domain rules only
   ```yaml
   payload:
     - google.com
     - youtube.com
     - ".facebook.com"  # Suffix match (prefix with dot)
   ```

2. **ipcidr** - Contains IP-CIDR rules only
   ```yaml
   payload:
     - 192.168.0.0/16
     - 10.0.0.0/8
     - 1.1.1.1/32
   ```

3. **classical** - Full rule syntax (mixed types)
   ```yaml
   payload:
     - DOMAIN, example.com
     - DOMAIN-SUFFIX, google.com
     - IP-CIDR, 192.168.0.0/16
     - PROCESS-NAME, firefox
   ```

### Provider File Format

```yaml
# For domain behavior
payload:
  - google.com
  - youtube.com
  - ".githubusercontent.com"  # Dot prefix = suffix match

# For ipcidr behavior
payload:
  - 192.168.0.0/16
  - 10.0.0.0/8
  - 172.16.0.0/12

# For classical behavior
payload:
  - DOMAIN, example.com
  - DOMAIN-SUFFIX, google.com
  - IP-CIDR, 1.2.3.0/24
```

### Using Rule Providers

```yaml
rule_provider:
  custom-domains:
    type: file
    behavior: domain
    path: ./rules/custom-domains.yaml

  private-networks:
    type: file
    behavior: ipcidr
    path: ./rules/private-ip.yaml

  ad-blocking:
    type: http
    behavior: domain
    url: https://example.com/ad-rules.yaml
    path: ./cache/ad-rules.yaml
    interval: 86400

rule_local:
  # Use providers
  - RULE-SET, custom-domains, DIRECT
  - RULE-SET, private-networks, DIRECT
  - RULE-SET, ad-blocking, REJECT

  # Regular rules
  - DOMAIN-SUFFIX, google.com, Proxy
  - FALLBACK, Proxy
```

## Complete Example

```yaml
# Configure GeoIP database
dispatching:
  geoip_db: ./GeoLite2-Country.mmdb

# Define rule providers
rule_provider:
  custom-domains:
    type: file
    behavior: domain
    path: ./rules/custom-domains.yaml

  ad-blocking:
    type: http
    behavior: domain
    url: https://anti-ad.net/domains.txt
    path: ./cache/ad-blocking.yaml
    interval: 86400

  private-ip:
    type: file
    behavior: ipcidr
    path: ./rules/private-networks.yaml

# Define routing rules
rule_local:
  # Block ads
  - RULE-SET, ad-blocking, REJECT

  # Local domains
  - DOMAIN-SUFFIX, local, DIRECT
  - DOMAIN-SUFFIX, localhost, DIRECT

  # Private networks
  - RULE-SET, private-ip, DIRECT
  - IP-CIDR, 127.0.0.0/8, DIRECT
  - IP-CIDR, ::1/128, DIRECT

  - RULE-SET, custom-domains, DIRECT

  # Specific applications
  - PROCESS-NAME, firefox, Proxy
  - PROCESS-NAME, chrome, Proxy

  # Per-inbound routing
  - INBOUND-ALIAS, work-proxy, Work-Proxies
  - INBOUND-ALIAS, personal-proxy, Personal-Proxies

  # Port-based rules
  - DST-PORT, 22/tcp, DIRECT  # SSH
  - DST-PORT, 53/udp, DIRECT  # DNS

  # Complex logic
  - AND, [DOMAIN-SUFFIX, netflix.com], [DST-PORT, 443], Netflix-Proxies
  - OR, [DOMAIN-SUFFIX, google.com], [DOMAIN-SUFFIX, googleapis.com], Proxy

  # Debugging
  - .INSTRUMENT:
      id: 1
      matches: DOMAIN-SUFFIX, api.example.com
      message: "[{time.hms_ms}] API request from {process.cmdline}"

  # Default fallback
  - FALLBACK, Proxy
```

## Best Practices

1. **Order matters:** Place more specific rules before general ones
   ```yaml
   - DOMAIN, specific.example.com, Proxy-A
   - DOMAIN-SUFFIX, example.com, Proxy-B  # Won't match specific.example.com
   ```

2. **Use FALLBACK:** Always end with a `FALLBACK` rule to handle unmatched traffic
   ```yaml
   - FALLBACK, Proxy
   ```

3. **Block ads early:** Put ad-blocking rules at the top for better performance
   ```yaml
   - RULE-SET, ad-blocking, REJECT
   - DOMAIN-SUFFIX, ads.example.com, REJECT
   # ... other rules ...
   ```

4. **Use rule providers:** For large rule sets, use providers instead of inline rules
   ```yaml
   rule_provider:
     large-list:
       type: http
       url: https://example.com/10000-domains.yaml
   ```

5. **Use `no-resolve` carefully:** For IP-CIDR rules on domains, use `no-resolve` to avoid DNS leaks
   ```yaml
   - IP-CIDR, 8.8.8.8/32, Proxy, no-resolve
   ```

6. **Test with .INSTRUMENT:** Use instrument actions to debug rule matching
   ```yaml
   - .INSTRUMENT:
       id: 999
       matches: DOMAIN-SUFFIX, test.com
       message: "Testing rule matched: {addr.dst}"
   ```

7. **Group related rules:** Use `.SUB-DISPATCH` to organize rules logically
   ```yaml
   - .SUB-DISPATCH:
       matches: PROCESS-NAME, my-app
       subrules:
         # All rules specific to my-app
   ```

8. **Optimize for performance:**
   - Put frequently matched rules at the top
   - Use `RULE-SET` for large lists instead of many individual rules
   - Use `no-resolve` when DNS resolution isn't needed

9. **Security considerations:**
   - Block dangerous domains early with `REJECT`
   - Use process-based rules to isolate untrusted applications
   - Route sensitive traffic through specific proxies or chains
